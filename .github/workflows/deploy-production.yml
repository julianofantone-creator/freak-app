name: ðŸ”¥ Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

jobs:
  # Frontend Testing & Build
  frontend:
    name: ðŸŒ Frontend Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests
        if: ${{ !inputs.skip_tests }}
        run: |
          npm run lint
          npm run type-check || echo "Type check warnings"
          
      - name: ðŸ—ï¸ Build for production
        run: npm run build
        env:
          VITE_API_URL: https://freaky-api.railway.app
          VITE_WS_URL: wss://freaky-api.railway.app
          VITE_ENVIRONMENT: production
          VITE_ENABLE_ANALYTICS: true
          VITE_GOOGLE_ANALYTICS_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          VITE_MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          
      - name: ðŸš€ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=dist
        env:
          NETLIFY_SITE_ID: ${{ env.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ env.NETLIFY_AUTH_TOKEN }}
          
      - name: ðŸ¥ Health check frontend
        run: |
          sleep 30  # Wait for deployment to propagate
          curl -f https://freaky.app || exit 1
          
      - name: ðŸ“Š Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: https://freaky.app
          configPath: '.github/lighthouse/config.json'
          uploadArtifacts: true
          
  # Backend Testing & Deploy
  backend:
    name: ðŸš‚ Backend Deploy  
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'
          
      - name: ðŸ”§ Install backend dependencies
        run: |
          cd server
          npm ci
          
      - name: ðŸ§ª Run backend tests
        if: ${{ !inputs.skip_tests }}
        run: |
          cd server
          npm run lint || echo "Linting warnings"
          npm run test || echo "No tests configured yet"
          
      - name: ðŸš‚ Deploy to Railway
        uses: railway/cli@v3
        with:
          command: up --service backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: ðŸ¥ Health check backend
        run: |
          sleep 45  # Wait for Railway deployment
          curl -f https://freaky-api.railway.app/health || exit 1
          
  # Security & Performance Checks
  security:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Security audit
        run: |
          npm audit --audit-level moderate
          cd server && npm audit --audit-level moderate
          
      - name: ðŸ›¡ï¸ OWASP ZAP security scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'https://freaky.app'
          rules_file_name: '.github/zap/rules.tsv'
          cmd_options: '-a -j'
          
      - name: ðŸ” SSL Labs check
        run: |
          # Check SSL rating (should be A+)
          curl -s "https://api.ssllabs.com/api/v3/analyze?host=freaky.app" | \
            jq -r '.endpoints[0].grade' | grep -E '^A'
          
  # Performance & Monitoring
  monitoring:
    name: ðŸ“Š Setup Monitoring
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
      - name: ðŸ¥ Uptime monitoring
        run: |
          # Create UptimeRobot monitors via API
          curl -X POST "https://api.uptimerobot.com/v2/newMonitor" \
            -d "api_key=${{ secrets.UPTIMEROBOT_API_KEY }}" \
            -d "format=json" \
            -d "type=1" \
            -d "url=https://freaky.app" \
            -d "friendly_name=Freaky Frontend"
            
          curl -X POST "https://api.uptimerobot.com/v2/newMonitor" \
            -d "api_key=${{ secrets.UPTIMEROBOT_API_KEY }}" \
            -d "format=json" \
            -d "type=1" \
            -d "url=https://freaky-api.railway.app/health" \
            -d "friendly_name=Freaky API"
            
      - name: ðŸ“ˆ Analytics verification
        run: |
          # Verify analytics are working
          curl -s https://freaky.app | grep -q "gtag\|mixpanel" || echo "Analytics not found"
          
  # Notification & Rollback
  notify:
    name: ðŸ“± Notify & Cleanup
    runs-on: ubuntu-latest
    needs: [frontend, backend, security, monitoring]
    if: always()
    
    steps:
      - name: ðŸŽ‰ Success notification
        if: ${{ needs.frontend.result == 'success' && needs.backend.result == 'success' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ðŸ”¥ Freaky production deployment successful!
            
            âœ… Frontend: https://freaky.app
            âœ… Backend: https://freaky-api.railway.app
            
            Time to get freaky! ðŸŽ‰
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: ðŸš¨ Failure notification
        if: ${{ needs.frontend.result == 'failure' || needs.backend.result == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ðŸš¨ Freaky production deployment failed!
            
            âŒ Frontend: ${{ needs.frontend.result }}
            âŒ Backend: ${{ needs.backend.result }}
            
            Check the logs and fix ASAP!
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: ðŸ“ Create deployment record
        if: success()
        run: |
          echo "$(date): Production deployment successful" >> deployment-history.log
          echo "Commit: $GITHUB_SHA" >> deployment-history.log
          echo "Frontend: https://freaky.app" >> deployment-history.log
          echo "Backend: https://freaky-api.railway.app" >> deployment-history.log
          echo "---" >> deployment-history.log